#!/usr/bin/env bash
set -euo pipefail

# generate_keystore script simplifies the process of generating a keystore for
# an Android app.
#
# Recommended key setup for LeanCode projects:
#
# $ generate_keystore "LeanCode" "new_great_app" "tst"
#
# $ generate_keystore "Our Awesome Client" "new_great_app" "prod_upload"
#
# $ generate_keystore "Our Awesome Client" "new_great_app" "prod"

_usage() {
	echo "usage: generate_keystore <owner> <app_name> <type>" 1>&2
}

if [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
	_usage
	exit 0
fi

owner="${1:-}"
if [ -z "$owner" ]; then
	echo "owner is not set" 1>&2
	_usage
	exit 1
fi

app_name="${2:-}"
if [ -z "$app_name" ]; then
	echo "app_name is not set" 1>&2
	_usage
	exit 1
fi

type="${3:-}"
if [ -z "$type" ]; then
	echo "type is not set" 1>&2
	_usage
	exit 1
fi

echo "Creating keystore for app $app_name (type: $type, owner: $owner) ..."

exec keytool -genkey \
	-keystore "${app_name}_$type.jks" \
	-keyalg RSA \
	-keysize 2048 \
	-validity 9125 `# 25 years (25 * 365 = 9125 days)` \
	-alias "${app_name}_$type" \
	-dname "O=$owner" \
	-noprompt \
	-storetype JKS
